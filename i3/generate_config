#!/bin/bash
set -euo pipefail -o noclobber # Bash sanity checking

export output="$HOME/.config/i3/config"
export includes="$HOME/.config/i3/config.d"
index="$HOME/.config/i3/config.d/index.txt"

DOTFILES="$(dirname "$(dirname "$(realpath "$0")"))")"
export DOTFILES

# Replace the current config file
[[ -f "$output" ]] && rm "$output"
touch "$output"
echo -e "### THIS FILE IS AUTOMATICALLY GENERATED FROM SOURCES IN ${includes} ###\n" >> "$output"

header () {
cat << EOF
# -----------------------------------------------------------------------------
#     FILE: ${1}
# -----------------------------------------------------------------------------
EOF
}

include_file () {

	# Include a header for each file
	header "$1" >> "$output"

	ext="${1##*.}"
	case $ext in
		# If the file is a 'conf' file, include it directly
		"conf")
			< "$includes/$1" "$DOTFILES/settings/settings" stream >> "$output"
		;;

		# If the file is a shell script, execute it
		"sh")
			< "$includes/$1" "$DOTFILES/settings/settings" stream >> "$output"
		;;

		*)
			>&2 echo "Unrecognised extension: $1"
		;;
	esac

	echo >> "$output"
}

export -f include_file
export -f header

grep -oP "import \K[a-zA-Z0-9\_\-\.]+(?=;)" "$index" | \
	  xargs -n 1 bash -c 'include_file "$@"' _

echo "# vi""m: filetype=i3config" >> "$output"
